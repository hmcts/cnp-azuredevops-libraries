---
version: 0.33.3
name: "Update ado-terraform-nagger terraform version"

scms:
  default:
    kind: github
    spec:
      user: '{{ .github.user }}'
      email: '{{ .github.email }}'
      owner: '{{ .github.owner }}'
      repository: '{{ .github.repository }}'
      token: '{{ or .github.token (requiredEnv "UPDATECLI_GITHUB_TOKEN") }}'
      username: '{{ or .github.user (requiredEnv "UPDATECLI_GITHUB_ACTOR") }}'
      branch: '{{ or .github.branch "main" }}'

sources:
  latestTerraformVersion:
    kind: githubrelease
    name: Get the latest published terraform version
    spec:
      owner: hashicorp
      repository: terraform
      token: '{{ or .github.token (requiredEnv "UPDATECLI_GITHUB_TOKEN") }}'
      versionfilter:
        kind: semver

targets:
  setTerraformVersion:
    sourceid: latestTerraformVersion
    name: Bump ado-terraform-nagger terraform version
    kind: json
    scmid: default
    spec:
      file: scripts/ado-terraform-nagger-versions.json
      key: .terraform.warn_below

actions:
  setTfcmtImageVersion:
    kind: github/pullrequest
    scmid: default
    title: >-
      [updatecli] Bump ado-terraform-nagger terraform version to {{ source "latestTerraformVersion" }}
    spec:
      automerge: false
      draft: false
      description: |
        Bump ado-terraform-nagger terraform version to {{ source "latestTerraformVersion" }}
