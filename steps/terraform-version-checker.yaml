---
parameters:
  - name: kvConnectedServiceName
  - name: component
  - name: workingDirectory
    default: $(System.DefaultWorkingDirectory)

steps:
  - checkout: self
  - checkout: cnp-azuredevops-libraries
  - template: ./set-build-repo-suffix-env-var.yaml

  - script: |
      git clone https://github.com/hmcts/cnp-deprecation-map.git
    displayName: Clone Depreciation Map
  
  - script: |
      echo "Saving output"
      echo "output data of failed versions" > test_result_${{ parameters.kvConnectedServiceName }}.txt
    displayName: Fake File
  
  - task: AzureKeyVault@1
    displayName: 'Retrieve slack webhook URL from Keyvault'
    inputs:
      runAsPreJob: false
      ConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      keyVaultName: 'infra-vault-nonprod'
      secretsFilter: 'registry-slack-webhook'

  - task: Bash@3
    displayName: Terraform version nagger
    inputs:
      targetType: 'inline'
      script: |
        python3 $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/ado-terraform-nagger.py \
        -f $(System.DefaultWorkingDirectory)/cnp-deprecation-map/nagger-versions.yaml
      workingDirectory: ${{ parameters.workingDirectory}}
    env:
      SLACK_WEBHOOK_URL: $(registry-slack-webhook)
      WORKDIR: ${{ parameters.workingDirectory}}


  - task: PublishPipelineArtifact@1
    displayName: 'Publish pipeline artifact'
    inputs:
      targetPath: '$(Pipeline.Workspace)'
      artifact: 'testing'
      publishLocation: 'pipeline'
