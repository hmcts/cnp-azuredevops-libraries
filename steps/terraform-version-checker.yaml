---
parameters:
  - name: kvConnectedServiceName
  - name: workingDirectory
    default: $(System.DefaultWorkingDirectory)
  - name: baseDirectory
    default: ''

steps:
  - checkout: self
  - checkout: cnp-azuredevops-libraries
  - template: ./set-build-repo-suffix-env-var.yaml

  - script: |
      git clone https://github.com/hmcts/cnp-deprecation-map.git
    displayName: clone deprecation map
  
  - task: AzureKeyVault@2
    displayName: 'Retrieve slack webhook URL from Keyvault'
    inputs:
      runAsPreJob: false
      ConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      keyVaultName: 'infra-vault-nonprod'
      secretsFilter: 'registry-slack-webhook'


  - script: |
      echo " TESTING"
      find . -name ".terraform.lock.hcl"
      wget -v  --spider -q --tries=2 --timeout=10 https://registry.terraform.io || exit 1
      echo "nothing"
      ping -c 4 8.8.8.8 || exit 1
      cd hub-panorama-terraform/components/configuration
      grep -R "3.25"
      ls -l
      # terraform init -reconfigure -upgrade 
      # terraform providers
      ls
    displayName: TESTING

  - task: Bash@3
    displayName: Terraform Nagger
    inputs:
      targetType: 'inline'
      script: |
        python3 $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/ado-terraform-nagger.py \
        -f $(System.DefaultWorkingDirectory)/cnp-deprecation-map/nagger-versions.yaml
    env:
      SLACK_WEBHOOK_URL: $(registry-slack-webhook)
      BASE_DIRECTORY: ${{ parameters.baseDirectory }}
      SYSTEM_DEFAULT_WORKING_DIRECTORY: $(System.DefaultWorkingDirectory)
      BUILD_REPO_SUFFIX: $(buildRepoSuffix)