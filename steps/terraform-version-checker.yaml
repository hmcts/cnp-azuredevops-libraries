---
parameters:
  - name: kvConnectedServiceName
  - name: environment_components
    type: object
  - name: workingDirectory
    default: $(System.DefaultWorkingDirectory)
  - name: baseDirectory
    default: ''

steps:
  - checkout: self
  - checkout: cnp-azuredevops-libraries
  - template: ./set-build-repo-suffix-env-var.yaml

  - script: |
      git clone https://github.com/hmcts/cnp-deprecation-map.git
    displayName: Clone Depreciation Map
  
  - task: AzureKeyVault@1
    displayName: 'Retrieve slack webhook URL from Keyvault'
    inputs:
      runAsPreJob: false
      ConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      keyVaultName: 'infra-vault-nonprod'
      secretsFilter: 'registry-slack-webhook'

  - task: Bash@3
    displayName: Terraform Nagger
    inputs:
      targetType: 'inline'
      script: |
        json=$(echo '${{ convertToJson(parameters.environment_components) }}')
        echo "$json" | jq '{ environment_components: . }' > environment_components.json
        echo "$json" | jq '{ environment_components: . }'
        python3 $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/ado-terraform-nagger.py \
        -f $(System.DefaultWorkingDirectory)/cnp-deprecation-map/nagger-versions.yaml \
        -e environment_components.json
    env:
      SLACK_WEBHOOK_URL: $(registry-slack-webhook)
      BASE_DIRECTORY: ${{ parameters.baseDirectory }}
      SYSTEM_DEFAULT_WORKING_DIRECTORY: $(System.DefaultWorkingDirectory)
      BUILD_REPO_SUFFIX: $(buildRepoSuffix)
