---
parameters:
  - name: kvConnectedServiceName
  - name: environment_components
    type: object
  - name: workingDirectory
    default: $(System.DefaultWorkingDirectory)

steps:
  - checkout: self
  - checkout: cnp-azuredevops-libraries
  - template: ./set-build-repo-suffix-env-var.yaml

  - script: |
      git clone https://github.com/hmcts/cnp-deprecation-map.git
    displayName: Clone Depreciation Map
  
  - task: AzureKeyVault@1
    displayName: 'Retrieve slack webhook URL from Keyvault'
    inputs:
      runAsPreJob: false
      ConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      keyVaultName: 'infra-vault-nonprod'
      secretsFilter: 'registry-slack-webhook'
  
  # - ${{ each deployment in parameters.environment_components }}:
  #   - template: ./install-use-tfswitch.yaml
  #     parameters:
  #       tfswitchArgs: -b ~/.local/bin/terraform
  #       ${{ if eq( parameters['baseDirectory'], '') }}:
  #         workingDirectory: '$(System.DefaultWorkingDirectory)/$(buildRepoSuffix)/components/${{ deployment.component }}'
  #       ${{ else }}:
  #         workingDirectory: '$(System.DefaultWorkingDirectory)/$(buildRepoSuffix)/${{ parameters.baseDirectory }}/${{ deployment.component }}'

  - task: Bash@3
    displayName: Serialize environment_components to JSON
    inputs:
      targetType: 'inline'
      script: |
        echo $(environment_components) > environment_components.json
        cat environment_components.json
      workingDirectory: ${{ parameters.workingDirectory }}

  - task: Bash@3
    displayName: Terraform Nagger
    inputs:
      targetType: 'inline'
      script: |
        python3 $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/ado-terraform-nagger.py \
        -f $(System.DefaultWorkingDirectory)/cnp-deprecation-map/nagger-versions.yaml \
        -e "$(cat environment_components.json)"
      workingDirectory: ${{ parameters.workingDirectory }}
    env:
      SLACK_WEBHOOK_URL: $(registry-slack-webhook)
      WORKDIR: ${{ parameters.workingDirectory }}
      SYSTEM_DEFAULT_WORKING_DIRECTORY: $(System.DefaultWorkingDirectory)
      BUILD_REPO_SUFFIX: $(buildRepoSuffix)