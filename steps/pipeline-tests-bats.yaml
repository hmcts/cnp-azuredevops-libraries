parameters:
- name: environment
  default: ''
- name: domain_prefix
  default: ''
- name: test_file
  default: ''
- name: workingDirectory
  default: ''
- name: junit_output_dir
  default: ''
- name: root_domain
  default: platform.hmcts.net

steps:
- task: Bash@3
  displayName: Run pipeline tests
  inputs:
    targetType: 'inline'
    script: |
      git submodule add https://github.com/bats-core/bats-core.git test/bats
      git submodule add https://github.com/bats-core/bats-support.git test/test_helper/bats-support
      git submodule add https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert
      mkdir -p ${{ parameters.junit_output_dir }}
      test/bats/bin/bats --report-formatter junit ${{ parameters.test_file }} --output ${{ parameters.junit_output_dir }}
    workingDirectory: '${{ parameters.workingDirectory }}'
    failOnStderr: false
  env:
    BATS_REPORT_FILENAME: yeet
    BATS_REPORT_FILE_NAME: report_$(system.jobId).xml
    ${{ if eq(parameters.environment, 'prod') }}:
      GLOBAL_DOMAIN_NAME: '${{ parameters.root_domain }}'
    ${{ else }}:
      GLOBAL_DOMAIN_NAME: '${{ parameters.domain_prefix }}.${{ parameters.root_domain }}'

- task: PublishTestResults@2
  displayName: Publish pipeline tests
  condition: always()
  inputs:
    testResultsFormat: 'JUnit'
    failTaskOnFailedTests: true
    testResultsFiles: '${{ parameters.junit_output_dir }}/*.xml'
    testRunTitle: 'Tests (${{ parameters.environment }})'
