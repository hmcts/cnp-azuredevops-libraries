parameters:
  serviceConnection: "azurerm-nonprod"
  registryServiceConnection: "azurerm-prod"
  aksResourceGroup: "cnp-aks-rg"
  aksCluster: "cnp-aks-cluster"
  acrName: "hmctspublic"
  chartName: ""
  chartReleaseName: ""
  chartNamespace: ""
  helmVersion: "2.11.0"

steps:
  - task: HelmInstaller@0
    inputs:
      helmVersion: ${{ parameters.helmVersion }}
      checkLatestHelmVersion: false
      installKubectl: false

  - task: AzureCLI@1
    displayName: "AKS Authenticate"
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptLocation: "inlineScript"
      inlineScript: az aks get-credentials --admin --resource-group ${{ parameters.aksResourceGroup }} --name ${{ parameters.aksCluster }}

  - task: AzureCLI@1
    displayName: "Add custom charts repo"
    inputs:
      azureSubscription: ${{ parameters.registryServiceConnection }}
      scriptLocation: "inlineScript"
      inlineScript: az acr helm repo add --name ${{ parameters.acrName }}

  - script: helm dependency update ${{ parameters.chartName }}
    displayName: "Retrieve helm dependencies (if any)"

  - script: helm package ${{ parameters.chartName }}
    displayName: "Helm Package"

  - task: AzureCLI@1
    displayName: "Helm Publish"
    inputs:
      azureSubscription: ${{ parameters.registryServiceConnection }}
      scriptLocation: "inlineScript"
      inlineScript: |
        set -x
        CHART_FILE=$(ls ${{ parameters.chartName }}-[0-9]*)
        az acr helm push --name ${{ parameters.acrName }} $CHART_FILE
