parameters:
  - name: repo_name
    default: ''

  - name: keyvaultName
    default: ''

  - name: keyvaultSecret
    default: ''

  - name: location
    default: 'UK South'
    values:
      - 'UK South'
      - 'UK West'

  - name: serviceConnection
    default: ''

  - name: overrideAction
    default: apply

  - name: forcePreventParallelJobRun
    displayName: Always force prevent parallem run job
    type: boolean
    default: false

  - name: kvConnectedServiceName
    default: 'azurerm-sandbox'

  - name: projectName
    default: 'ss'

  - name: environment
    default: 'sbox'

  - name: runManualStart
    type: boolean
    default: false

  - name: baseDirectory
    default: ''

steps:
  - checkout: self
  - checkout: cnp-azuredevops-libraries
  
  - task: AzureKeyVault@2
    displayName: 'Get GitHub API token from Keyvault'
    condition: eq(variables['Build.Reason'], 'PullRequest')
    inputs:
      runAsPreJob: false
      ConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      keyVaultName: 'infra-vault-nonprod'
      secretsFilter: 'github-api-token'
  
  - task: Bash@3
    displayName: 'Check master/main branch build status'
    continueOnError: true  # Don't fail the pipeline if the check fails
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      GITHUB_TOKEN: $(github-api-token)
      BUILD_REPOSITORY_NAME: $(Build.Repository.Name)
      BUILD_REASON: $(Build.Reason)
    inputs:
      targetType: 'inline'
      script: |
        bash $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/check-master-build-status.sh
      
  - template: ./set-build-repo-suffix-env-var.yaml

  - template: ./install-use-tfswitch.yaml
    parameters:
      tfswitchArgs: -b ~/.local/bin/terraform --latest
      workingDirectory: $(System.DefaultWorkingDirectory)/$(buildRepoSuffix)

  - task: AzureKeyVault@2
    displayName: 'Retrieve keyvault secret for ADO token'
    inputs:
      ConnectedServiceName: ${{ parameters.serviceConnection }}
      keyVaultName: ${{ parameters.keyvaultName }}
      secretsFilter: ${{ parameters.keyvaultSecret }}
      runAsPreJob: false

  - task: AzureKeyVault@2
    displayName: 'Get GitHub API token from Keyvault'
    inputs:
      runAsPreJob: false
      ConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      keyVaultName: 'infra-vault-nonprod'
      secretsFilter: 'aks-manual-start-github-app-priv-key,aks-manual-start-github-app-id,aks-manual-start-github-app-installation-id'

  - task: AzureCLI@2
    displayName: Trigger Github Action AKS Manual Start
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -euo pipefail
        # Create temporary file for private key
        TEMP_KEY_FILE=$(mktemp)
        echo "$(aks-manual-start-github-app-priv-key)" > "$TEMP_KEY_FILE"
        
        # Call script with temp priv key file path
        $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/trigger-manual-deploy.sh \
          "$TEMP_KEY_FILE" \
          "$(aks-manual-start-github-app-id)" \
          "$(aks-manual-start-github-app-installation-id)" \
          "${{parameters.projectName}}" \
          "${{parameters.environment}}"
        
        # Cleanup the priv key file
        rm -f "$TEMP_KEY_FILE"
    condition: ${{ eq(parameters.runManualStart, true) }}

  - script: |
      cd $(System.DefaultWorkingDirectory)/${{ parameters.repo_name }}
      terraform fmt -check -recursive
      terraform fmt -recursive
    displayName: 'Terraform Formating '
    continueOnError: true


  - task: PowerShell@2
    displayName: Run PESTER tests
    inputs:
      targetType: 'filePath'
      filePath: $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/pester-tests.ps1
      pwsh: true

  - task: PublishTestResults@2
    displayName: 'Publish Test Results **/TEST-*.xml'
    inputs:
      testResultsFormat: NUnit
      failTaskOnFailedTests: true
    condition: always()

  - task: Bash@3
    displayName: Getting SP bearer token
    inputs:
      targetType: 'inline'
      script: |
        SPTOKEN=$(curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d 'client_id=10936009-a112-4733-bb2a-94ee240b79ff&scope=499b84ac-1321-427f-aa17-267ca6975798/.default&client_secret=$(azure-devops-sp-token)&grant_type=client_credentials' 'https://login.microsoftonline.com/531ff96d-0ae9-462a-8d2d-bec7c0b42082/oauth2/v2.0/token' | jq -r '.access_token')
        echo "##vso[task.setvariable variable=SPTOKEN;]$SPTOKEN"
        
  - task: Bash@3
    displayName: Prevent parallel run
    # Run step if (not a plan and is manually triggered) or (branch is main and is auto triggered)
    condition: |
      and(succeeded(),
        or(
            eq(${{ parameters.forcePreventParallelJobRun }}, true),
            and(
                ne('${{ parameters.overrideAction }}', 'plan'),
                eq(variables['isAutoTriggered'], false)
            ),
            and(
                eq(variables['isAutoTriggered'], true),
                eq(variables['isMain'], true)
            )
        )
      )
    env:
      thisbuild: $(Build.BuildId)
      pipelinedefinition: $(System.DefinitionId)
      azuredevopstoken: $(SPTOKEN)
    inputs:
      targetType: inline
      script: |
        set -x
        # Validate SPTOKEN
        if [ -z "$SPTOKEN" ] || [ "$SPTOKEN" == "null" ]; then
          echo "##vso[task.logissue type=error]Failed to retrieve SP bearer token. The token is empty or null."
          echo "##vso[task.logissue type=error]Check that the azure-devops-sp-token secret exists in the key vault and the service principal credentials are valid. e.g. client id (i.e. application id) for the SP 'azure-devops-sp'"
          exit 1
        fi
        
        echo "SP bearer token retrieved successfully"
                
        python3 $(System.DefaultWorkingDirectory)/cnp-azuredevops-libraries/scripts/ado-build-check.py \
        --pat "$(SPTOKEN)" \
        --buildid "$(Build.BuildId)" \
        --organization "hmcts" \
        --project "$(System.TeamProject)" \
        --pipelineid "$(System.DefinitionId)"

  - template: ./terraform-version-checker.yaml
    parameters:
      kvConnectedServiceName: ${{ parameters.kvConnectedServiceName }}
      baseDirectory: ${{ parameters.baseDirectory }}
